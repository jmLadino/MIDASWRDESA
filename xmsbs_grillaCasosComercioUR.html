<html><head>
    <meta charset="utf-8">
    <title>Casos por Comercio y UR</title>
<!--<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>-->
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.5.1.js"></script>    
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">
    <script src="https://midaschiledesa.crm2.dynamics.com//WebResources/xmsbs_JumpStarLibXRM"></script>
    <script src="https://midaschiledesa.crm2.dynamics.com//WebResources/xmsbs_webAPI"></script>
    <script src="https://midaschiledesa.crm2.dynamics.com//WebResources/xmsbs_formularioCaso"></script>
    <script src="ClientGlobalContext.js.aspx" type="text/javascript"></script>

    <link href="https://cdn.datatables.net/1.10.23/css/jquery.dataTables.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://cdn.datatables.net/1.10.23/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/select/1.3.1/js/dataTables.select.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.6.5/js/dataTables.buttons.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.6.5/js/buttons.html5.min.js"></script>
    <style>
        .obligatorio {
            color: rgb(234, 6, 0);
        }

        .loader {
            border: 16px solid #f3f3f3;
            border-radius: 50%;
            border-top: 16px solid #3498db;
            width: 120px;
            height: 120px;
            -webkit-animation: spin 2s linear infinite; /* Safari */
            animation: spin 2s linear infinite;
        }

        thead th {
            background-color: rgb(221, 8, 8);
            color: white;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
        }

        .pagination li {
            display: block;
        }

        /* Safari */
        @-webkit-keyframes spin {
            0% {
                -webkit-transform: rotate(0deg);
            }

            100% {
                -webkit-transform: rotate(360deg);
            }
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
    <script type="text/javascript">
        var parametroApiKey = "AuthApi";
        var parametroAzure = "AzureURL";
        var baseUrl = "";
        var apiKey = "";
        var urlCRM = "";

        function get(url, successFunction) 
        {
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function (data) {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    successFunction(JSON.parse(data.currentTarget.response));
                }
            }

            xhr.open("GET", baseUrl + url, true);
            xhr.setRequestHeader("Accept", "application/json");
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.setRequestHeader("AuthApi", apiKey);
            xhr.send();
        }

        function post(url, params, successFunction) 
        {
            var xhr = new XMLHttpRequest();
            xhr.open("POST", baseUrl + url, true);
            xhr.setRequestHeader("Accept", "application/json");
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.setRequestHeader("AuthApi", apiKey);

            xhr.onreadystatechange = function (data) {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    successFunction(JSON.parse(data.currentTarget.response));
                }
            }

            xhr.send(JSON.stringify(params));
        }
                
        function setDisabled(item, bool) 
        {
            if (bool) {
                $("#" + item).prop('disabled', true);
            }
            else {
                $("#" + item).prop('disabled', false);
            }
        }  

        function setCasosComercioUR(data) 
        {
            $('#dvLoader').css("display", "block");
            if (data.success) 
            {
                if (data.listCaso.length > 0)
                {
                    var html = template(data.listCaso);    
                    $("#tbody").html(html);
                    tabla = $('#tblCasos').DataTable({
                        dom: 'Bfrtip',
                        buttons: [
                            { extend: 'excel', text: 'Descargar a Excel' }
                        ],
                        language: {
                            "sProcessing":     "Procesando...",
                            "sLengthMenu":     "Mostrar _MENU_ registros",
                            "sZeroRecords":    "No se encontraron resultados",
                            "sEmptyTable":     "Ningún dato disponible en esta tabla",
                            "sInfo":           "Mostrando registros del _START_ al _END_ de un total de _TOTAL_ registros",
                            "sInfoEmpty":      "Mostrando registros del 0 al 0 de un total de 0 registros",
                            "sInfoFiltered":   "(filtrado de un total de _MAX_ registros)",
                            "sSearch":         "Buscar:",
                            "sInfoThousands":  ",",
                            "sdvLoaderRecords": "Cargando...",
                            "oPaginate": {
                                "sFirst":    "Primero",
                                "sLast":     "Último",
                                "sNext":     "Siguiente",
                                "sPrevious": "Anterior"
                            },
                            "oAria": {
                                "sSortAscending":  ": Activar para ordenar la columna de manera ascendente",
                                "sSortDescending": ": Activar para ordenar la columna de manera descendente"
                            },
                            "buttons": {
                                "copy": "Copiar",
                                "colvis": "Visibilidad"
                            }
                        },
                        select: {
                            style: "multi",
                            info: false
                        },                        
                        "info": true,
                        "paging": false,
                        columnDefs: [
                            { "type": "date-eu", "targets": [0] }                    
                        ]
                    });
                }
                
                $('#dvLoader').css("display", "none");
            }
            else 
            {
                $('#dvLoader').css("display", "none");
                alert(data.message);
            }
        }
        
        function template(data) {            
            var html = '';
            $.each(data, function (index, item) {
                html += '<tr>';
                html += '<td>' + item.FechaCreacion + '</td>';                        
                html += '<td>' + item.NumeroCaso + '</td>';                        
                html += '<td>' + item.RutComercio + '</td>';
                html += '<td>' + item.Comercio + '</td>';
                html += '<td>' + getLabelStateCode(item.Estado) + '</td>';
                html += '<td>' + item.TipoRequerimiento + '</td>';
                html += '<td>' + item.Producto + '</td>';
                html += '<td>' + item.TipoYDetalleOperacion + '</td>';
                html += '<td>' + item.UR + '</td>';                        
                html += '<td>' + "<a href='" + urlCRM + "/main.aspx?etn=incident&pagetype=entityrecord&id=%7B" + item.Id + "%7D" + "' target='_blank'>Ver Registro</a>"; + '</td>';
                html += '</tr>';
            });

            return html;
        }
        
        function getLabelStateCode(statecode)
        {
            var etiqueta = "";
            switch (statecode) {
              case 0:
                etiqueta = "Activo";
                break;
              case 1:
                etiqueta = "Resuelto";
                break;
              case 2:
                etiqueta = "Cancelado";
                break;
              default:
                etiqueta = "";
                break;
            }
            
            return etiqueta;
        }
        
        function getLabelStatusCode(statuscode)
        {
            var etiqueta = "";
            switch (statuscode) {
              case 1:
                etiqueta = "En Ingreso";
                break;
              case 2:
                etiqueta = "En Gestión";
                break;
              case 3:
                etiqueta = "En Reparo";
                break;
              case 4:
                etiqueta = "Visado";
                break;
              case 5:
                etiqueta = "Finalizado";
                break;
              case 6:
                etiqueta = "Cancelado";
                break;
              case 2000:
                etiqueta = "Combinado";
                break;
              case 657130000:
                etiqueta = "En Visación";
                break;
              case 657130001:
                etiqueta = "En Cierre";
                break;
              case 657130002:
                etiqueta = "En Gestión Solicitante";
                break;
              default:
                etiqueta = "";
                break;
            }
            
            return etiqueta;
        }

        function setClientApiContext(xrm, executionContext, formContext, data) {
            //debugger;
            
            window.Xrm = xrm;
            window._executionContext = executionContext;
            window._formContext = formContext;
            
            let globalContext = window.Xrm.Utility.getGlobalContext();
            urlCRM = globalContext.getClientUrl();
            
            setCasosComercioUR(data);
        }
            
        $(document).ready(function () {
            jQuery.extend( jQuery.fn.dataTableExt.oSort, {
                "date-eu-pre": function ( date ) {
                    date = date.replace(" ", "");
                     
                    if ( ! date ) {
                        return 0;
                    }
             
                    var year;
                    var eu_date = date.split(/[\.\-\/]/);
             
                    /*year (optional)*/
                    if ( eu_date[2] ) {
                        year = eu_date[2];
                    }
                    else {
                        year = 0;
                    }
             
                    /*month*/
                    var month = eu_date[1];
                    if ( month.length == 1 ) {
                        month = 0+month;
                    }
             
                    /*day*/
                    var day = eu_date[0];
                    if ( day.length == 1 ) {
                        day = 0+day;
                    }
             
                    return (year + month + day) * 1;
                },
             
                "date-eu-asc": function ( a, b ) {
                    return ((a < b) ? -1 : ((a > b) ? 1 : 0));
                },
             
                "date-eu-desc": function ( a, b ) {
                    return ((a < b) ? 1 : ((a > b) ? -1 : 0));
                }
            });
        });
    </script>
<meta><meta><meta><meta></head>
<body>
    <div class="data-container">
        <div class="parent" id="dvLoader">
            <p style="text-align:center">
                <img src="xmsbs_loading32gif">
            </p>
        </div>
        <div id="divCasos" class="form-group">
            <table id="tblCasos" class="table table-bordered cell-border">
                <thead>
                    <tr>
                        <th scope="col" style="width: 10%">Fecha</th>
                        <th scope="col" style="width: 10%">N° Correlativo</th>                        
                        <th scope="col" style="width: 10%">Rut</th>
                        <th scope="col" style="width: 10%">Comercio</th>
                        <th scope="col" style="width: 10%">Estado</th>
                        <th scope="col" style="width: 10%">Tipo Requerimiento</th>                        
                        <th scope="col" style="width: 10%">Producto</th>
                        <th scope="col" style="width: 10%">Tipo y Detalle</th>
                        <th scope="col" style="width: 10%">Unidad Resolutora</th>
                        <th scope="col" style="width: 10%">Registro</th>
                    </tr>
                </thead>
                <tbody id="tbody"></tbody>                
            </table>
        </div>       
    </div>
    <div id="pagination-container" class="pagination"></div>
</body></html>