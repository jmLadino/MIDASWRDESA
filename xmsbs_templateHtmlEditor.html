<!DOCTYPE html>
<html>
<head>
    <title>Editor de Plantilla Avanzado para Incident (Case)</title>
    <meta charset="utf-8" />
    <script src="ClientGlobalContext.js.aspx" type="text/javascript"></script>
	<script src="/WebResources/xmsbs_JumpStarLibXRM"></script>
	<script src="/WebResources/xmsbs_webAPI"></script>
	<script src="/WebResources/xmsbs_util"></script>    

    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 10px; background-color: #f7f7f7; min-height: 100vh; padding-top: 10px; }
		.control-panel { display: flex; flex-direction: column; gap: 5px; padding: 10px; border: 1px solid #c2c2c2; background-color: #ffffff; margin-bottom: 10px; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); position: sticky; top: 0; z-index: 10; width: 100%; box-sizing: border-box; }        
		.control-row { display: flex; flex-wrap: wrap;  gap: 8px;  align-items: center; }		
        .editor-header {  display: flex;  justify-content: space-between;  align-items: center;  margin-bottom: 10px; }
		.format-button, .format-select { padding: 6px 10px; cursor: pointer; font-size: 16px; background-color: #e6e6e6; border: 1px solid #ccc; border-radius: 3px; min-width: 30px; transition: background-color 0.2s, border-color 0.2s; }
        .format-button:hover, .format-select:hover { background-color: #d1d1d1; border-color: #b3b3b3; }
        .format-button:active { background-color: #c0c0c0; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); }
        .separator { border-left: 1px solid #ccc; margin: 0 10px; }

		#editor-content { border: 1px solid #ccc; min-height: 250px; padding: 10px; background-color: white; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
		#campos-disponibles, .format-button, .format-select {  padding: 5px; cursor: pointer;  font-size: 14px; }
		
		.save-button { padding: 10px 15px; background-color: #e81123; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; transition: background-color 0.2s; }
        .save-button:hover { background-color: #c40f1f; }		
		
		.placeholder-campo { color: darkblue; font-weight: bold; background-color: #e0e0ff; padding: 1px 3px; }	
        .resizable-image-wrapper { display: inline-block; position: relative; cursor: move; border: 2px solid #0078d4; }
        .resize-handle { position: absolute; width: 10px; height: 10px; background-color: #0078d4; border: 1px solid white; z-index: 1000; cursor: grab; }
        .resize-handle.bottom-right { bottom: -5px; right: -5px; cursor: nwse-resize; }
        .resize-handle.bottom-left { bottom: -5px; left: -5px; cursor: nesw-resize; }
        .resize-handle.top-right { top: -5px; right: -5px; cursor: nesw-resize; }
        .resize-handle.top-left { top: -5px; left: -5px; cursor: nwse-resize; }

        /* COLORES */
	 	.color-control-group { display: flex; align-items: center; gap: 5px; }
        .color-palette { display: flex; gap: 2px; border: 1px solid #ccc; padding: 2px; border-radius: 3px; }
        .color-square { width: 18px; height: 18px; cursor: pointer; border: 1px solid #333;  transition: transform 0.1s; box-shadow: 0 0 1px rgba(0,0,0,0.5); }
        .color-square:hover { transform: scale(1.1); border-color: #000; }
    </style>
</head>
<body>

    <!--<div class="editor-header">
        <h3>Plantilla:</h3>
        <button onclick="guardarPlantilla()" class="save-button">
            üíæ Guardar Plantilla
        </button>
    </div>!-->
    
    <div class="control-panel">
		<div class="control-row">
		
			<select id="formatBlock" class="format-select" onchange="ejecutarComando('formatBlock', this.value)">
				<option value="P">P√°rrafo</option>
				<option value="H1">Encabezado 1</option>
				<option value="H2">Encabezado 2</option>
				<option value="H3">Encabezado 3</option>
			</select>

			<span class="separator"></span>

			<button class="format-button" onclick="ejecutarComando('bold')" title="Negrita">ùêÅ</button>
			<button class="format-button" onclick="ejecutarComando('italic')" title="Cursiva">ùë∞</button>
			<button class="format-button" onclick="ejecutarComando('underline')" title="Subrayado">ùêîÃ≤</button>
			<button class="format-button" onclick="ejecutarComando('strikeThrough')" title="Tachado">‚Ç¶</button>
			
			<!-- Por defecto no se puede pegar texto con formato, as√≠ que este bot√≥n ya es irrelevante
				Se conserva la funcionalidad a modo de respaldo !-->
			<!--
			<span class="separator"></span>
			<button class="format-button" onclick="ejecutarComando('removeFormat')" title="Quitar todo el formato">üßπ Limpiar</button>
			!-->
			
			<span class="separator"></span>

			<button class="format-button" onclick="ejecutarComando('insertUnorderedList')" title="Vi√±etas">‚Ä¢ Lista</button>
			<button class="format-button" onclick="ejecutarComando('insertOrderedList')" title="Lista Numerada">1. Lista</button>
			<button class="format-button" onclick="ejecutarComando('indent')" title="Aumentar Sangr√≠a">‚áâ</button>
			<button class="format-button" onclick="ejecutarComando('outdent')" title="Disminuir Sangr√≠a">‚áá</button>

			<span class="separator"></span>
			
			<button class="format-button" onclick="ejecutarComando('justifyLeft')" title="Alinear Izquierda">‚á§</button>
			<button class="format-button" onclick="ejecutarComando('justifyCenter')" title="Centrar">‚Äì</button>
			<button class="format-button" onclick="ejecutarComando('justifyRight')" title="Alinear Derecha">‚á•</button>
			
			
			<span class="separator"></span>
			
			<label for="colorSelect" style="font-weight: bold; margin-left: 5px;">Color:</label>
			<select id="colorSelect" class="format-select" onchange="aplicarColor(this.value)" title="Seleccionar Color de Texto"></select>
			
			<label for="backgroundColorSelect" style="font-weight: bold; margin-left: 5px;">Fondo:</label>
			<select id="backgroundColorSelect" class="format-select" onchange="aplicarColorFondo(this.value)" title="Seleccionar Color de Fondo"></select>
			
			<button class="format-button" onclick="recargarPlantilla()" title="Recargar Plantilla desde Dynamics">üîÑ Recargar</button>
		</div> 

		<div class="control-row">		
			<label for="campos-disponibles" style="font-weight: bold;">Insertar Campo:</label>
			<select id="campos-disponibles" onchange="insertarCampo()">
				<option value="">-- Seleccione un campo --</option>
			</select>

			<label for="imageSelect" style="font-weight: bold;">Insertar Imagen:</label>
			<select id="imageSelect" class="format-select" onchange="insertarImagen(this.value)" title="Seleccionar Imagen a Insertar">
			</select>
        <!--<button class="format-button" onclick="ejecutarComandoLink()" title="Crear Enlace">üîó Enlace</button>!-->
        <!--<button class="format-button" onclick="ejecutarComandoImagen()" title="Insertar Imagen URL">üñºÔ∏è URL</button>!-->
		</div> 		
    </div>

    <div id="editor-content" contenteditable="true">
        
    </div>

    <script>
        let currentResizableWrapper = null;
        let isResizing = false;
        let startX, startY, startWidth, startHeight;
		let NombrePlantilla = "";
		const MAX_REINTENTOS = 10;
		
        window.onload = function() {
        	debugger;
            window._formContext = window.parent.Xrm.Page;

            cargarPlantillaExistente(); 
			generarPicklistColores();
			generarPicklistColoresFondo();
			generarPicklistImagenes();
			
            document.getElementById('formatBlock').value = 'P';
			//document.getElementById('editor-content').addEventListener('paste', handlePasteEvent);
			
			const editor = document.getElementById('editor-content');
			editor.addEventListener('paste', handlePasteEvent);
			editor.addEventListener('click', handleImageClick);
            document.addEventListener('mousemove', resizeImage);
            document.addEventListener('mouseup', stopResize);
            editor.focus();
			
            document.execCommand('enableObjectResizing', false, false);
			editor.addEventListener('input', debounce(actualizarCampoPlantilla, 500));
        };

        async function cargarCamposEntidad() {
            const select = document.getElementById('campos-disponibles');
            
            debugger;

            // en esta entrega el conjunto de campos es fijo seg√∫n el DO (se asume que solo existe 1 DO en la Grilla)
            // posteriormente se debe implementar una lectura de campos seg√∫n los DO en la Grilla, pudi√©ndo existir N DO en la grilla.

            // por ahora solo filtra por el nombre de la plantilla

			const CAMPOS_CAD = {
                'emailaddress1': '(Cliente) Correo electr√≥nico',
                'address1_line1': '(Cliente) Direccion y N√∫mero',
                'CALC_NombreCompletoCliente': '(Cliente) Nombre Completo',
                'mobilephone': '(Cliente) Tel√©fono Celular',
                'CANT_TRANSACCIONES': 'Cantidad de Transacciones (Calculado)',
                'createdon': 'Fecha de creaci√≥n',
                'xmsbs_fechadebloqueo': 'Fecha eliminaci√≥n de claves',
                'CALC_FechaHoraActual': 'Fecha y Hora Actual',
                'xmsbs_texto5g': 'Hora eliminaci√≥n de claves',
                'xmsbs_monto': 'Monto',
                'xmsbs_numerocorrelativo': 'N¬∞ Correlativo',
                'xmsbs_contratotexto': 'N¬∞ de Cuenta',
                'xmsbs_rut': 'RUT',
                'title': 'T√≠tulo del Caso'
			};
		
			const CAMPOS_TC = {
                'emailaddress1': '(Cliente) Correo electr√≥nico',
                'address1_line1': '(Cliente) Direccion y N√∫mero',
                'CALC_NombreCompletoCliente': '(Cliente) Nombre Completo',
                'mobilephone': '(Cliente) Tel√©fono Celular',
                'xmsbs_numerodecuenta': '(Contrato) N√∫mero de Cuenta',
                'xmsbs_numerodetarjeta': '(Contrato) N√∫mero de Tarjeta',
                'xmsbs_fechadebloqueo': 'Fecha de Bloqueo Tarjeta',
                'createdon': 'Fecha de creaci√≥n',
                'CALC_FechaHoraActual': 'Fecha y Hora Actual',
                'xmsbs_texto4g': 'Hora de Bloqueo',
                'xmsbs_montoreclamado': 'Monto Reclamado',
                'xmsbs_montoreclamadousd': 'Monto Reclamado USD',
                'xmsbs_numerocorrelativo': 'N¬∞ Correlativo',
                'xmsbs_rut': 'RUT',
                'title': 'T√≠tulo del Caso'
			};

            const CAMPOS_TD = {
                'emailaddress1': '(Cliente) Correo electr√≥nico',
                'address1_line1': '(Cliente) Direccion y N√∫mero',
                'CALC_NombreCompletoCliente': '(Cliente) Nombre Completo',
                'mobilephone': '(Cliente) Tel√©fono Celular',
                'xmsbs_numerodecuenta': '(Contrato) N√∫mero de Cuenta',
                'xmsbs_numerodetarjeta': '(Contrato) N√∫mero de Tarjeta',
                'xmsbs_fechadebloqueo': 'Fecha de Bloqueo Tarjeta',
                'createdon': 'Fecha de creaci√≥n',
                'CALC_FechaHoraActual': 'Fecha y Hora Actual',
                'xmsbs_texto4g': 'Hora de Bloqueo',
                'xmsbs_montoreclamado': 'Monto Reclamado',
                'xmsbs_montoreclamadousd': 'Monto Reclamado USD',
                'xmsbs_numerocorrelativo': 'N¬∞ Correlativo',
                'xmsbs_rut': 'RUT',
                'title': 'T√≠tulo del Caso'
            };

            var CAMPOS = null;
            // falla en la primera carga
            //var NombrePlantilla = window._formContext.getAttribute("xmsbs_name").getValue();

            debugger;
            if (NombrePlantilla == "CERTIFICADO CANALES A DISTANCIA")
                CAMPOS = CAMPOS_CAD;
            else if (NombrePlantilla == "CERTIFICADO TARJETA DE CR√âDITO")
                CAMPOS = CAMPOS_TC;
            else if (NombrePlantilla == "CERTIFICADO TARJETA DE D√âBITO")
                CAMPOS = CAMPOS_TD;

            for (const logicalName in CAMPOS) {
                const displayName = CAMPOS[logicalName];
                const option = document.createElement('option');
                option.value = `{{${logicalName}}}`; 
                option.textContent = displayName;
                select.appendChild(option);
            }
        }

        function insertarCampo() {
            const select = document.getElementById('campos-disponibles');
            const placeholder = select.value;
            
            if (placeholder) {
                //const htmlToInsert = `<span style="color: darkblue; font-weight: bold; background-color: #e0e0ff; padding: 1px 3px;">${placeholder}</span>&nbsp;`;
				const htmlToInsert = `<span class="placeholder-campo">${placeholder}</span>&nbsp;`;
                document.execCommand('insertHTML', false, htmlToInsert);
                select.value = ""; 
                document.getElementById('editor-content').focus();
            }
        }

		async function cargarPlantillaExistente() {
			const htmlContent = await fetchTemplateFromWebAPI();
			const editor = document.getElementById('editor-content');

			if (htmlContent === null) {
				editor.innerHTML = ''; 
				return;
			}

			editor.innerHTML = htmlContent;
		}

		async function fetchTemplateFromWebAPI() {
			try {
				const clientUrl = window._formContext.context.getClientUrl();
				const entityName = window._formContext.data.entity.getEntityName();
				const recordId = window._formContext.data.entity.getId().replace(/[{}]/g, ''); 
				
				if (!recordId || recordId === '00000000-0000-0000-0000-000000000000') 
					return null; 
				
				const webApiUrl = `${clientUrl}/api/data/v9.1/${entityName}s(${recordId})?$select=xmsbs_plantillahtml,xmsbs_name`;
				const response = await fetch(webApiUrl, {
					method: 'GET',
					headers: {
						'OData-MaxVersion': '4.0',
						'OData-Version': '4.0',
						'Accept': 'application/json',
						'Content-Type': 'application/json; charset=utf-8'
					}
				});

				if (!response.ok) {
					throw new Error(`Web API Request failed with status: ${response.status}`);
				}

				const data = await response.json();
				
                debugger;
                NombrePlantilla = data.xmsbs_name || ''; 
                await cargarCamposEntidad();

                return data.xmsbs_plantillahtml || ''; 

			} catch (e) {
				throw e; 
			}
		}

		function recargarPlantilla() {
			const confirmacion = confirm("ADVERTENCIA: Los cambios no guardados en el editor se PERDER√ÅN. ¬øDesea continuar?");
			
			if (confirmacion) {
				const editor = document.getElementById('editor-content');
				editor.innerHTML = 'Cargando...'; 
				
				cargarPlantillaExistente()
					.then(() => {
						console.log("Recarga forzada completada.");
					})
					.catch(e => {
						alert(`Ocurri√≥ un error al recargar la plantilla desde Web API: ${e.message}`);
						editor.innerHTML = 'Error al cargar. Intente de nuevo.';
					});
			}
			document.getElementById('editor-content').focus();
		}

		// ----------- COLORES
		const PICKLIST_COLORES = {
			'Negro': '#000000',
			'Rojo': '#FF0000',
			'Azul': '#0000FF',
			'Verde': '#008000',
			'Naranja': '#FFA500',
			'P√∫rpura': '#800080',
			'Gris': '#808080',
			'Blanco': '#FFFFFF' 
		};

		function aplicarColor(color) {
			if (color) {
				document.execCommand('foreColor', false, color);
			}
			document.getElementById('editor-content').focus();
		}
		
		function aplicarColorFondo(color) {
			if (color) {
				document.execCommand('backColor', false, color);
			}
			document.getElementById('editor-content').focus();
		}		

		function generarPicklistColores() {
			const select = document.getElementById('colorSelect');
			
			let defaultOption = document.createElement('option');
			defaultOption.value = '';
			defaultOption.textContent = 'Seleccionar...';
			select.appendChild(defaultOption);

			for (const [nombre, valor] of Object.entries(PICKLIST_COLORES)) {
				let option = document.createElement('option');
				option.value = valor;
				option.textContent = nombre;
				option.style.color = valor; 
				option.style.backgroundColor = (valor === '#FFFFFF') ? '#f0f0f0' : '#FFFFFF'; 
				select.appendChild(option);
			}
			
			select.addEventListener('change', function() {
				if (this.value !== '') {
					setTimeout(() => this.value = '', 100); 
				}
			});
		}

		function generarPicklistColoresFondo() {
			const select = document.getElementById('backgroundColorSelect');
			
			let defaultOption = document.createElement('option');
			defaultOption.value = '';
			defaultOption.textContent = 'Fondo...';
			select.appendChild(defaultOption);
			
			let removeOption = document.createElement('option');
			removeOption.value = 'transparent'; 
			removeOption.textContent = '‚ö†Ô∏è Limpiar Fondo';
			select.appendChild(removeOption);

			for (const [nombre, valor] of Object.entries(PICKLIST_COLORES)) {
				if (valor === '#000000') continue; 
				
				let option = document.createElement('option');
				option.value = valor;
				option.textContent = nombre;
				option.style.backgroundColor = valor; 
				option.style.color = (valor === '#FFFFFF' || valor === '#C0C0C0' || valor === '#FFA500') ? '#000000' : '#FFFFFF';
				select.appendChild(option);
			}
			
			select.addEventListener('change', function() {
				if (this.value !== '') {
					setTimeout(() => this.value = '', 100); 
				}
			});
		}		
		// ----------- FIN COLORES
		
		// ----------- INSERTAR IMAGENES
		const IMAGENES_DISPONIBLES = {
			'Imagen...': '',
			'Logo Banco': 'https://midaschiledesa.crm2.dynamics.com//WebResources/xmsbs_logosantandercertificados'
		};
		function generarPicklistImagenes() {
			const select = document.getElementById('imageSelect');
			
			for (const [nombre, url] of Object.entries(IMAGENES_DISPONIBLES)) {
				let option = document.createElement('option');
				option.value = url;
				option.textContent = nombre;
				select.appendChild(option);
			}
			
			select.addEventListener('change', function() {
				if (this.value !== '') {
					setTimeout(() => this.value = '', 100); 
				}
			});
		}
		function insertarImagen(url) {
			if (url) {
				document.execCommand('insertImage', false, url);
				document.execCommand('enableObjectResizing', false, true); 
			}
			document.getElementById('editor-content').focus();
		}
		function saveImageDimensions() {
			const editor = document.getElementById('editor-content');
			const images = editor.querySelectorAll('img');
			images.forEach(img => {
				const currentWidth = img.clientWidth;
				const currentHeight = img.clientHeight;
				img.setAttribute('width', currentWidth);
				img.setAttribute('height', currentHeight);
			});
		}
		// ----------- FIN INSERTAR IMAGENES
		
		// ----------- CONTROLAR IMAGENES
        function handleImageClick(e) {
            if (currentResizableWrapper) {
                removeResizeWrapper(currentResizableWrapper);
            }
            
            if (e.target && e.target.tagName === 'IMG' && e.target.closest('#editor-content')) {
                wrapImage(e.target);
            }
        }
        
        function wrapImage(imgElement) {
            if (imgElement.parentNode.classList && imgElement.parentNode.classList.contains('resizable-image-wrapper')) {
                return;
            }

            const wrapper = document.createElement('div');
            wrapper.className = 'resizable-image-wrapper';
            
            wrapper.style.width = imgElement.offsetWidth + 'px';
            wrapper.style.height = imgElement.offsetHeight + 'px';
            
            imgElement.parentNode.insertBefore(wrapper, imgElement);
            wrapper.appendChild(imgElement);
            
            ['top-left', 'top-right', 'bottom-left', 'bottom-right'].forEach(pos => {
                const handle = document.createElement('div');
                handle.className = `resize-handle ${pos}`;
                handle.addEventListener('mousedown', startResize);
                wrapper.appendChild(handle);
            });
            
            currentResizableWrapper = wrapper;
        }
        
        function startResize(e) {
            e.preventDefault();
            e.stopPropagation(); 
            isResizing = true;
            currentResizableWrapper = e.target.parentNode;
            startX = e.clientX;
            startY = e.clientY;
            startWidth = parseInt(document.defaultView.getComputedStyle(currentResizableWrapper).width, 10);
            startHeight = parseInt(document.defaultView.getComputedStyle(currentResizableWrapper).height, 10);
        }

        function resizeImage(e) {
            if (!isResizing || !currentResizableWrapper) return;
            
            const newWidth = startWidth + (e.clientX - startX);
            const newHeight = startHeight + (e.clientY - startY);

            currentResizableWrapper.style.width = newWidth + 'px';
            currentResizableWrapper.style.height = newHeight + 'px';

            const img = currentResizableWrapper.querySelector('img');
            if (img) {
                img.style.width = '100%';
                img.style.height = '100%';
            }
        }
        
        function stopResize() {
            if (isResizing) {
                isResizing = false;
                // Importante: Eliminar los wrappers al final para mantener el HTML limpio (opcional)
                // removeResizeWrapper(currentResizableWrapper); 
                // Pero lo dejaremos para mantener la selecci√≥n hasta que se haga clic fuera.
            }
        }
        
        function removeResizeWrapper(wrapper) {
            const img = wrapper.querySelector('img');
            if (img) {
                img.style.width = wrapper.style.width; 
                img.style.height = wrapper.style.height; 
                img.style.removeProperty('max-width'); 
                img.style.removeProperty('max-height');
                wrapper.parentNode.insertBefore(img, wrapper);
            }
            wrapper.remove();
            currentResizableWrapper = null;
        }
		// ----------- FIN CONTROLAR IMAGENES
		
        // --- Funciones de Edici√≥n, Pegado y Exportaci√≥n ---

		function handlePasteEvent(event) {
			event.preventDefault(); 
			const clipboardData = event.clipboardData || window.clipboardData;
			
			if (clipboardData.items) {
				for (let i = 0; i < clipboardData.items.length; i++) {
					const item = clipboardData.items[i];
					
					// if (item.type.indexOf("image") !== -1) { 
					//     // L√≥gica anterior que permit√≠a la imagen
					//     return; // Bloquea el pegado de imagen
					// } 
					
					// Solo procesamos texto plano
					if (item.type === "text/plain") {
						const plainText = clipboardData.getData('text/plain');
						document.execCommand('insertText', false, plainText);
						return; 
					}
				}
			} else {
				const plainText = clipboardData.getData('Text');
				if (plainText) {
					document.execCommand('insertText', false, plainText);
				}
			}
		}

        function ejecutarComando(command, value = null) {
            document.execCommand(command, false, value);
            document.getElementById('editor-content').focus();
        }
        
        function ejecutarComandoLink() {
            const url = prompt("Ingrese la URL para el enlace:", "https://");
            if (url) {
                document.execCommand('createLink', false, url);
            }
            document.getElementById('editor-content').focus();
        }
		
        function ejecutarComandoImagen() {
            const url = prompt("Ingrese la URL de la imagen:", "https://");
            if (url) {
                document.execCommand('insertImage', false, url);
            }
            document.getElementById('editor-content').focus();
        }
		
		let saveTimeout = null; 
		function debounce(func, delay) {
			return function() {
				const context = this;
				const args = arguments;
				clearTimeout(saveTimeout);
				saveTimeout = setTimeout(() => func.apply(context, args), delay);
			};
		}
		
		function actualizarCampoPlantilla() {
			const htmlContent = document.getElementById('editor-content').innerHTML;
			
			try {
                const campoPlantilla = window._formContext.getAttribute("xmsbs_plantillahtml");
                if (campoPlantilla) {
                    campoPlantilla.setValue(htmlContent); 
                    // Opcional: Notificar que el valor ha cambiado
                    // campoPlantilla.fireOnChange();
                }
			} 
			catch (e) {
				console.warn("Error al actualizar el campo de plantilla:", e);
			}
		}		
		
		function guardarPlantilla() {
            const htmlContent = document.getElementById('editor-content').innerHTML;
            
            try {
                const campoPlantilla = window._formContext.getAttribute("xmsbs_plantillahtml");
                if (campoPlantilla) {
                    campoPlantilla.setValue(htmlContent);
                    window._formContext.data.entity.save(); 
                    alert("Plantilla guardada correctamente.");
                }
            } 
			catch (e) {
                alert("Ocurri√≥ un error al guardar: ${e.message}.");
                console.error("Error al guardar la plantilla:", e);
            }
        }		
    </script>
</body>
</html>