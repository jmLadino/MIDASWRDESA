<!DOCTYPE html>
<html>
<head>
    <title>Seleccionar Opción</title>
    <meta charset="utf-8">
    <script src="ClientGlobalContext.js.aspx" type="text/javascript"></script>
	<script src="/WebResources/xmsbs_JumpStarLibXRM"></script>
	<script src="/WebResources/xmsbs_webAPI"></script>
	<script src="/WebResources/xmsbs_util"></script>
    <style>
        body { font-family: Segoe UI, Tahoma, Geneva, Verdana, sans-serif; padding: 10px; }
        .field-container { margin-bottom: 20px; border: 1px solid #ccc; padding: 10px; }
        .field-title { font-weight: bold; margin-bottom: 10px; border-bottom: 2px solid #0078d4; padding-bottom: 5px; color: #0078d4;}
        .option-item { border: 1px solid #eee; margin-bottom: 5px; padding: 8px; cursor: pointer; transition: background-color 0.2s; }
        .option-item:hover { background-color: #f0f8ff; border-color: #0078d4; }
        .option-name { font-weight: bold; }
        .option-description { font-size: 0.9em; color: #555; }
        .no-options { color: #888; font-style: italic; }
    </style>
	<script>
// Variable global para almacenar el contexto de la organización (URL)
var Xrm = parent.Xrm;
var orgUrl = Xrm.Utility.getGlobalContext().getClientUrl();

function initializeModal() {
	window._executionContext = window.parent.getExecutionContext();
	debugger;
	
	try {
		loadDynamicOptions();

	} catch (e) {
		document.getElementById('dynamicContent').innerHTML = "<div class='no-options'>Error al procesar datos: " + e.message + "</div>";
	}
}

function loadDynamicOptions() {
	debugger;
	
    var dynamicContentDiv = document.getElementById('dynamicContent');
    dynamicContentDiv.innerHTML = ''; // Limpiar el mensaje de carga

	var etapaId = JumpStartLibXRM.Fx.getLookupValueId(window._executionContext, "xmsbs_etapa");
	if (!etapaId){
		dynamicContentDiv.innerHTML = "<div class='no-options'>Error al cargar datos: No existe etapa</div>";
		return;
	}
	
	//var datosCompletos = [];

	debugger;
	// lectura de todos los campos activos de la etapa, que además la fnc al cambiar sea "Seleccion de Opcion"
	var lstCampos = buscarCamposTextoSeleccionOpcion(etapaId);
	
	var htmlContent = '';
	var hasContent = false;
			
	for (var oCampo of lstCampos.value){
		//var lstSel = getFieldOptions(oCampo.xmsbs_campoid, oCampo.xmsbs_nombremostrar);
		var lstSel = buscarSeleccionOpciones(oCampo.xmsbs_campoid);
		
		hasContent = true;
		// Construir el contenedor del campo
		htmlContent += "<div class='field-container'>";
		htmlContent += "<div class='field-title'>" + oCampo.xmsbs_nombremostrar + "</div>";
					
		for (var oItem of lstSel.value){
			//datosCompletos.push({campoId: oCampo.xmsbs_campoid,campoLabel: oCampo.xmsbs_nombremostrar,itemTitulo: oItem.xmsbs_name,itemDetalle: oItem.xmsbs_descripcion});

			var optioname = oItem.xmsbs_name.replace(/'/g, "\\'");
			var optiondescription = oItem.xmsbs_descripcion.replace(/'/g, "\\'");
		
			htmlContent += "<div class='option-item' onclick='selectOption('"+oCampo.xmsbs_name+"','"+optioname+"')'>";
			htmlContent += "<div class='option-name'>${option.name}</div>";
			htmlContent += "<div class='option-description'>" + oItem.xmsbs_descripcion + "</div>";
			htmlContent += "</div>";

		}
		htmlContent += '</div>';
	}
	
	if (hasContent) {
		dynamicContentDiv.innerHTML = htmlContent;
	} else {
		dynamicContentDiv.innerHTML = "<div class='no-options'>No hay opciones configuradas para los campos evaluados.</div>";
	}	
}

// ODATA

function buscarCamposTextoSeleccionOpcion(etapaId){
	//debugger;
	var entityType = "xmsbs_campo";
	var query = "$select=xmsbs_campoid,xmsbs_name,xmsbs_nombremostrar";
	query += "&$filter=(_xmsbs_etapa_value eq '" + etapaId.replace(/[{}]/g, "") + "' and xmsbs_tipocampo eq 1 and xmsbs_fncjsonchange eq 657130010)";
	var resultado = SDK.WEBAPI.retrieveMultipleRecords(window._executionContext, entityType, query, null, null, function () {});
	return resultado;
}	

function buscarSeleccionOpciones(campoId){
	//debugger;
	var entityType = "xmsbs_conjuntodeopcionesgenerico";
	var query = "$select=xmsbs_name,xmsbs_descripcion";
	query += "&$filter=(_xmsbs_campo_value eq '" + campoId.replace(/[{}]/g, "") + "')";
	var resultado = SDK.WEBAPI.retrieveMultipleRecords(window._executionContext, entityType, query, null, null, function () {});
	return resultado;
}			

function getFieldOptions(campoId, nombreCampo) {
	debugger;

	

	
	/*
		return new Promise((resolve, reject) => {
		   

			var data = buscarSeleccionOpciones(campoId);
			var options = data.value.map(item => ({
							name: item.xmsbs_name,
							description: item.xmsbs_descripcion
						}));
						
			if (options && options.value.length > 0){
				resolve({ fieldName: nombreCampo, options: options });
			}
			else{
				resolve({ fieldName: nombreCampo, options: [] });
			}
		});
	*/
}

function selectOption(fieldName, name) {

    //var selectedValue = { 
    //    fieldName: fieldName, 
    //    name: name, 
    //    description: description,
    //    valueToSet: '${name} - ${description}' // Ejemplo de valor a retornar/establecer
    //};
    
    // setea el campo
	debugger;
	JumpStartLibXRM.Fx.setValueField(window._executionContext,fieldName, name);
    
}

function closeModal() {
    // Cerrar el modal sin devolver resultado.
    //window.parent.Xrm.Navigation.closeModal();
	
	window.close();
}	
	</script>
</head>
<body onload="initializeModal()">
    <h1>Opciones de Asistencia</h1>
    <div id="dynamicContent">
        Cargando opciones...
    </div>
    <div style="text-align: right; margin-top: 20px;">
        <button onclick="closeModal()">Cerrar</button>
    </div>
</body>
</html>