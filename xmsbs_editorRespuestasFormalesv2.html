<html>
<head>
    <meta charset="UTF-8">
    <title>Editor de respuestas Formales</title>
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.css" rel="stylesheet">
    <script src="https://midaschiledesa.crm2.dynamics.com//WebResources/xmsbs_summernote_lite_min_js"></script>
    <script src="https://midaschiledesa.crm2.dynamics.com//WebResources/xmsbs_summerNote_es-ES"></script>
    <script src="https://midaschiledesa.crm2.dynamics.com//WebResources/xmsbs_repositorioSucesos"></script>

    <style>
        body {
            font-family: 'Segoe UI', Arial;
        }

        .ocultar {
            display: none;
        }

        .boton {
            border: 0px;
            padding-left: 15px;
            background-color: #efefef;
            padding-right: 15px;
            padding-top: 5px;
            padding-bottom: 5px;
            cursor: pointer;
            font-family: "Segoe UI", Arial;
            font-weight: bold;
            color: rgb(221, 8, 8);
        }

        .div-botonera {
            text-align: right;
            padding-right: 10px;
            margin-right: 10px;
        }

        .select-css {
            font-size: 16px;
            font-family: sans-serif;
            font-weight: 700;
            color: #444;
            line-height: 1.3;
            padding: .6em 1.4em .5em .8em;
            width: 70%;
            max-width: 100%; /* useful when width is set to anything other than 100% */
            box-sizing: border-box;
            margin: 0;
            border: 1px solid #aaa;
            appearance: none;
            background-color: #fff;
            /* Hide arrow icon in IE browsers */
            .select-css::-ms-expand

        {
            display: none;
        }
        /* Hover style */
        .select-css:hover {
            border-color: #888;
        }
        /* Focus style */
        .select-css:focus {
            border-color: #aaa;
            /* It'd be nice to use -webkit-focus-ring-color here but it doesn't work on box-shadow */
            box-shadow: 0 0 1px 3px rgba(59, 153, 252, .7);
            box-shadow: 0 0 0 3px -moz-mac-focusring;
            color: #222;
            outline: none;
        }
    </style>
</head>
<body>
    <div id="loading">
        <p style="text-align:center">
            <img src="https://midaschiledesa.crm2.dynamics.com//WebResources/xmsbs_loading32gif" />
        </p>
    </div>
    <div id="contenedor">
        <div id="SelectorPlantilla">
            Seleccione Plantilla
            <select name="plantillas" id="plantillas" class="select-css">
            </select>
            <p></p>
        </div>
        <div id="summernote"></div>
        <div id="botonera" class="div-botonera">
            <p></p>
            <button type="button" class="boton" onclick="cerrar()">Cerrar</button>
            <button type="button" class="boton" id="submit" onclick="guardar()">Guardar</button>
            <button type="button" class="boton" onclick="previsualizar()">Previsualizar</button>
        </div>
    </div>

<!--    <button type="button" onclick="getCode()">Get code</button>-->
    <script>
        var apiKey = "56C3D9E6-E5B6-4B76-816F-5741FA0420BE";
        //var urlBase ='http://localhost:58839/';
        var urlBase = 'https://santandermidasapi.azurewebsites.net/';
        function apiGet(url, successFunction) {
            var xhr = new XMLHttpRequest();
            xhr.onreadystatechange = function (data) {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    successFunction(JSON.parse(data.currentTarget.response));
                }
            }

            xhr.open("GET", urlBase + url, true);
            xhr.setRequestHeader("Accept", "application/json");
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.setRequestHeader("AuthApi", apiKey);
            xhr.send();
        }
        function apiPost(url, params, successFunction) {
            var xhr = new XMLHttpRequest();
            xhr.open("POST", urlBase + url, true);
            xhr.setRequestHeader("Accept", "application/json");
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.setRequestHeader("AuthApi", apiKey);

            xhr.onreadystatechange = function (data) {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    successFunction(JSON.parse(data.currentTarget.response));
                    //isLoading(false);
                }
            }

            xhr.send(JSON.stringify(params));
            //isLoading(true);
        }
        $('#contenedor').hide();
        var casoId = null;
        var currentContent = null;
        $('#summernote').summernote({
            placeholder: 'Ingrese su respuesta',
            tabsize: 2,
            height: 400,
            toolbar: [
                ['style', ['style']],
                ['font', ['bold', 'underline', 'italic']],
                //['color', ['color']],
                ['para', ['ul', 'ol', 'paragraph', 'height']],
                ['table', ['table']],
                //['insert', ['link', 'picture', 'video']],
                //['view', ['fullscreen', 'codeview', 'help']]
            ],
            lang: "es-ES"
        });
        window.addEventListener('message', function (event) {
            debugger;
            console.log('message received:  ' + event.data, event);
            let package = event.data;
            casoId = package.casoId;
            currentContent = package.contenido;
            //if (!currentContent) { currentContent = "<p></p>"; }
            let markupStr = currentContent;
            $('#summernote').summernote('code', markupStr);
            event.source.postMessage('Ok');
            loadDropDown(casoId);

        }, false);

        function getCode() {
            let markupStr = $('#summernote').summernote('code');
            console.log(markupStr);
            return markupStr;

        }
        function guardar() {
            debugger;
            let sel = document.getElementById('plantillas');
            let idPlantilla = sel.value;
            let nombrePlantilla = sel.innerText;
            let datos = getCode();
            let modelo = {
                idPlantilla: idPlantilla,
                nombrePlantilla: nombrePlantilla,
                respuesta: datos
            }
            opener.RepositorioSucesos.setRespuestaFormales(modelo);
            window.close();

        }
        function previsualizar() {
            debugger;
            let ruta = 'caso/PreviewRespuestaManualCaso';
            let contenido = getCode();
            let sel = document.getElementById('plantillas');
            let mdl = {
                idIncident: casoId,
                content: contenido,
                idPlantilla: sel.value
            };
            apiPost(ruta, mdl, function (data) {
                //debugger;
                if (data && data.success) {
                    //debugger;
                    //let pdfWindow = opener.window.open("")
                   // pdfWindow.document.write(
                    //    "<iframe width='100%' height='100%' src='data:application/pdf;base64, " +
                    //    encodeURI(data.respuestaPDFEmailBase64) + "'></iframe>"
                    //)
                    debugger;
                const linkSource = `data:application/pdf;base64,${data.respuestaPDFEmailBase64}`;
                const downloadLink = document.createElement("a");
                const fileName = "respuesta_formales.pdf";
                downloadLink.href = linkSource;
                downloadLink.download = fileName;
                downloadLink.click();
                    
                }
            });

        }
        function cerrar() {
            window.close();
        }
        function loadDropDown(casoId) {
            debugger;
            let ruta = 'respuestaPredefinida/GetPlantillasRespuesta/' + casoId;
            apiGet(ruta, function (data) {
                if (data && data.success) {
                    let sel = document.getElementById('plantillas');
                    for (var i = 0; i < data.listPlantillas.length; i++) {
                        let opt = document.createElement('option');
                        opt.value = data.listPlantillas[i].id;
                        opt.innerText = data.listPlantillas[i].nombre;
                        sel.appendChild(opt);
                    }
                    $('#loading').hide();
                    $('#contenedor').show();
                }
            })
        }
    </script>
</body>
</html>